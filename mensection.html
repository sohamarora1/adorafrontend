<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men's Section - Trendify</title>
    <!-- Styles and external dependencies -->
    <link rel="stylesheet" href="styles.css">
    <script src="auth.js"></script>
    <script src="cart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</head>
<body>
<header class="header">
    <!-- Header Section -->
    <div class="header-top" data-header>
        <div class="container">
            <a href="index.html" class="logo">
                <img src="assets/logoletter.png" width="100" height="18" alt="Trendify">
            </a>
            <div class="header-actions">
                <button class="header-action-btn" id="profile-btn">
                    <ion-icon name="person-outline"></ion-icon>
                    <span class="profile-initial" id="profileInitial" style="display:none;"></span>
                </button>
                <button class="header-action-btn" id="cart-btn">
                    <ion-icon name="bag-handle-outline"></ion-icon>
                    <span id="cart-count">0</span>
                    <data class="btn-text" id="cart-total">₹0.00</data>
                </button>
            </div>
            <nav class="navbar">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="men.html">Men</a></li>
                    <li><a href="women.html">Women</a></li>
                    <li><a href="profile.html" id="profile-link">Profile</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<h1>Men's Section</h1>
<div class="container">
    <section id="college-outfits" class="product-section">
        <h2>Formals</h2>
        <div class="product-grid"></div>
    </section>
    <section id="trendy-outfits" class="product-section">
        <h2>Festive Outfits</h2>
        <div class="product-grid"></div>
    </section>
    <section id="casual-outfits" class="product-section">
        <h2>Casual Outfits</h2>
        <div class="product-grid"></div>
    </section>
</div>

<footer>
    <p>&copy; 2023 Trendify. All Rights Reserved.</p>
</footer>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Check user authentication
        const token = localStorage.getItem('token');
        if (token) {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData && userData.name) {
                const profileInitial = document.getElementById('profileInitial');
                profileInitial.textContent = userData.name[0].toUpperCase();
                profileInitial.style.display = 'block';
            }
        }

        // Fetch products and display them
        const products = await fetchProducts();
        displayProducts(products, 'formals', '#college-outfits .product-grid');
        displayProducts(products, 'festives', '#trendy-outfits .product-grid');
        displayProducts(products, 'casuals', '#casual-outfits .product-grid');

        // Update cart display
        updateCartDisplay();

        // Handle add-to-cart logic
        document.addEventListener('click', async function (e) {
            if (e.target && e.target.classList.contains('btn-add-to-cart')) {
                const productId = e.target.getAttribute('data-product-id');
                const product = products.find(p => p._id === productId);
                if (product) {
                    await addToCart(product);
                }
            }
        });
    });

    // Fetch Products
    async function fetchProducts() {
        try {
            const response = await fetch('https://adora-t8e8.onrender.com/api/product/all');
            const data = await response.json();
            return data.products;
        } catch (error) {
            console.error('Error fetching products:', error);
            return [];
        }
    }

    // Display Products
    function displayProducts(products, category, containerSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;

        products.forEach(product => {
            if (product.category === 'mensection' && product.type === category) {
                const productCard = `
                    <div class="product-card">
                        <img src="${product.imgSrc}" alt="${product.title}" class="product-image">
                        <div class="product-info">
                            <h3>${product.title}</h3>
                            <p>₹${product.price.toFixed(2)}</p>
                            <button class="btn-add-to-cart" data-product-id="${product._id}">Add to Cart</button>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            }
        });
    }

    // Add to Cart
    async function addToCart(product) {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Please login to add items to your cart.');
            return;
        }

        try {
            const response = await fetch('https://adora-t8e8.onrender.com/api/cart/add', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productId: product._id, qty: 1 })
            });
            if (response.ok) {
                alert('Product added to cart successfully!');
                updateCartDisplay();
            } else {
                alert('Failed to add product to cart.');
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
        }
    }

    // Update Cart Display
    async function updateCartDisplay() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const response = await fetch('https://adora-t8e8.onrender.com/api/cart/user', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const cartItems = data.cart.items || [];
            const totalCount = cartItems.reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = cartItems.reduce((sum, item) => sum + item.price * item.qty, 0);

            document.getElementById('cart-count').textContent = totalCount;
            document.getElementById('cart-total').textContent = `₹${totalPrice.toFixed(2)}`;
        } catch (error) {
            console.error('Error updating cart display:', error);
        }
    }
</script>
</body>
</html>
