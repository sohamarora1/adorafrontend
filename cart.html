<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <style>
        /* (Keep the existing styles) */
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Shopping Cart</h1>
        <div onclick="window.location.href='products.html'">üè™ Back to Store</div>
    </nav>

    <div class="cart-container" id="cartContainer">
        <div id="cartItems"></div>
        <div class="cart-total" id="cartTotal"></div>
        <button class="clear-cart" onclick="clearCart()">Clear Cart</button>
    </div>

    <script>
        async function addToCart(productId, title, price, imgSrc) {
    const token = localStorage.getItem('token'); // Retrieve the token

    if (!token) {
        // Redirect to login if the user is not logged in
        alert('Please login to add items to your cart.');
        localStorage.setItem('returnTo', window.location.href); // Save the current page for redirect after login
        window.location.href = 'login.html';
        return;
    }

    try {
        // Make a POST request to the backend API
        const response = await fetch('https://adora-t8e8.onrender.com/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Auth': token, // Include the token in the Auth header
            },
            body: JSON.stringify({
                productId,
                title,
                price,
                qty: 1, // Default quantity when adding to cart
                imgSrc,
            }),
        });

        const data = await response.json();

        if (response.ok) {
            // Successfully added to cart
            alert('Product added to your cart!');
            updateCartDisplay(); // Update cart display (optional)
        } else {
            // Handle any errors returned by the backend
            alert(data.message || 'Failed to add product to cart.');
        }
    } catch (error) {
        console.error('Error adding product to cart:', error);
        alert('Something went wrong while adding to cart. Please try again.');
    }
}

// Attach an event listener to the "Add to Cart" buttons
document.addEventListener('click', async function (e) {
    if (e.target && e.target.classList.contains('btn-add-to-cart')) {
        const productId = e.target.getAttribute('data-product-id');
        const products = await fetchProducts(); // Fetch all products
        const product = products.find((p) => p._id === productId); // Find the selected product

        if (product) {
            // Call the addToCart function with the product details
            addToCart(product._id, product.title, product.price, product.imgSrc);
        }
    }
});

// Optional: Update cart display (if you want to show cart count dynamically)
async function updateCartDisplay() {
    const token = localStorage.getItem('token');
    if (!token) return; // If not logged in, don't update the cart

    try {
        const response = await fetch('https://adora-t8e8.onrender.com/api/cart/user', {
            headers: {
                'Auth': token,
            },
        });
        const data = await response.json();

        // Update the cart count and total on the UI
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');

        const itemCount = data.cart?.items.reduce((total, item) => total + item.qty, 0) || 0;
        const totalPrice = data.cart?.items.reduce((total, item) => total + item.pricePerUnit * item.qty, 0) || 0;

        cartCount.textContent = itemCount; // Update cart item count
        cartTotal.textContent = `‚Çπ ${totalPrice.toFixed(2)}`; // Update cart total price
    } catch (error) {
        console.error('Error updating cart display:', error);
    }
}
    </script>
</body>
</html>
