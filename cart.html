<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">Your Cart</h1>
        
        <div id="cart-items" class="space-y-4">
            <!-- Cart items will be dynamically populated here -->
        </div>
        
        <div id="cart-summary" class="mt-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Cart Summary</h2>
            <div class="flex justify-between">
                <p>Total Items:</p>
                <p id="total-items">0</p>
            </div>
            <div class="flex justify-between">
                <p>Total Price:</p>
                <p id="total-price">₹0.00</p>
            </div>
            <button id="proceed-to-checkout" class="w-full bg-blue-500 text-white py-2 rounded mt-4 hover:bg-blue-600">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        const cartItemsContainer = document.getElementById('cart-items');
        const totalItemsElement = document.getElementById('total-items');
        const totalPriceElement = document.getElementById('total-price');
        const proceedToCheckoutBtn = document.getElementById('proceed-to-checkout');

        async function fetchUserCart() {
            try {
                const response = await fetch('https://adora-t8e8.onrender.com/api/cart/user', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'auth': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch cart');
                }

                const data = await response.json();
                return data.cart.items;
            } catch (error) {
                console.error('Error fetching cart:', error);
                return [];
            }
        }

        async function renderCart() {
            const cartItems = await fetchUserCart();
            
            cartItemsContainer.innerHTML = '';
            let totalItems = 0;
            let totalPrice = 0;

            cartItems.forEach(item => {
                totalItems += item.qty;
                totalPrice += item.price;

                const cartItemElement = document.createElement('div');
                cartItemElement.classList.add('bg-white', 'p-4', 'rounded-lg', 'flex', 'items-center', 'justify-between', 'shadow-md');
                cartItemElement.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${item.imgSrc}" alt="${item.title}" class="w-20 h-20 object-cover rounded">
                        <div>
                            <h3 class="font-semibold">${item.title}</h3>
                            <p>₹${item.price.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="decrease-qty bg-gray-200 px-2 rounded" data-product-id="${item.productId}">-</button>
                        <span>${item.qty}</span>
                        <button class="increase-qty bg-gray-200 px-2 rounded" data-product-id="${item.productId}">+</button>
                        <button class="remove-item text-red-500" data-product-id="${item.productId}">Remove</button>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItemElement);
            });

            totalItemsElement.textContent = totalItems;
            totalPriceElement.textContent = `₹${totalPrice.toFixed(2)}`;
        }

        async function updateProductQuantity(productId, type) {
            try {
                const url = type === 'increase' 
                    ? 'https://adora-t8e8.onrender.com/api/cart/add'
                    : 'https://adora-t8e8.onrender.com/api/cart/--qty';
                
                const body = type === 'increase' 
                    ? { productId, qty: 1 }
                    : { productId, qty: 1 };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'auth': token
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error('Failed to update quantity');
                }

                await renderCart();
            } catch (error) {
                console.error('Error updating quantity:', error);
            }
        }

        async function removeProduct(productId) {
            try {
                const response = await fetch(`https://adora-t8e8.onrender.com/api/cart/remove/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'auth': token
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to remove product');
                }

                await renderCart();
            } catch (error) {
                console.error('Error removing product:', error);
            }
        }

        cartItemsContainer.addEventListener('click', async (e) => {
            const productId = e.target.getAttribute('data-product-id');
            
            if (e.target.classList.contains('increase-qty')) {
                await updateProductQuantity(productId, 'increase');
            }
            
            if (e.target.classList.contains('decrease-qty')) {
                await updateProductQuantity(productId, 'decrease');
            }
            
            if (e.target.classList.contains('remove-item')) {
                await removeProduct(productId);
            }
        });

        proceedToCheckoutBtn.addEventListener('click', () => {
            window.location.href = 'checkout.html';
        });

        renderCart();
    });
    </script>
</body>
</html>
